---
###############################################################################
# Forgejo Service Configuration
###############################################################################
# Skeleton database must be setup before role is applied (except SQLite).
# Database backend migrations (SQLite/Postgres/MySQL) must be done manually.
#
# WARNING
# > Migrations from Gitea/Gogs in practice require manual intervention.
# >
# > ALWAYS backup databases and all repository data (or make a snapshot) before
# > attempting a migration.
# >
# > Suggest creating a new container with data/db snapshots with Forgejo, then
# > removing the old instance once confirmed working.
# >
# > Reference:
# > * https://forgejo.org/docs/latest/admin/upgrade/from-gitea/
#
# Install size: ~162MB
#    Forgejo: ~102MB.
#   Packages: ~60MB.

# Forgejo Release.
#
# Existing databases are migrated automatically when new versions are
# installed but may not support backward compatibility. Always read release
# notes before updating versions. Role is only developed for LTS releases.
#
# Versions (Schematic):
#       MAJOR: Unsafe - requires major role changes; only default MAJOR LTS
#              version is supported. See other branches if they exist.
#       MINOR: Unsafe - New functionality may not be properly supported in
#              configuration.
#       PATCH: Safe - Usually requires no role updates.
#   RECOMMEND: Only increment PATCH. Never use 'latest'.
#
# Values:
#   {VERSION}: Tagged release to use ('v11.0.3').
#      latest: Use latest stable release.
#
# Default: 'v.11.0.3'.
#
# Reference:
# * https://forgejo.org/releases
forgejo_srv_version: 'v11.0.3'

# Forgejo GPG key ID.
#
# Binary installations are automatically validated against the published key
# with the specified ID.
#
# Reference:
# * https://keys.openpgp.org/search
# * https://forgejo.org/download
forgejo_srv_gpg_key_id: 'EB114F5E6C0DC2BCDD183550A4B61A2DC5923710'

# Enable installation of Redis memcache server?
#
# A local Redis server will be configured automatically with default options as
# default configuration assumes it exists. Disable if managing Redis
# externally.
#
# Default: True.
forgejo_srv_redis_enable: true

# Manage local Forgejo users.
#
# forgejo_srv_local_users:
#     list of dict - User accounts to manage.
#   - username: str - Username.
#     password: str - Password.
#     email: str - Email.
#     admin: bool - Enable administrator privileges for account.
#         Default: False.
#     must_change_password: bool - Force password change on login.
#         Default: True.
#     restricted: bool - Enable restricted user account.
#         Default: False.
#     state: str - User state.
#         Values:
#           present: Create user.
#            absent: Delete user.
#         Default: 'present'.
#
# forgejo_srv_local_users:
#   - username: 'admin_user'
#     password: 'admin'
#     email: 'admin@example.com'
#     admin: true
#   - username: 'standard_user'
#     password: 'sample'
#     email: 'user@example.com'
#     must_change_password: true
#   - username: 'old_admin'
#     state: 'absent'
#
# Default: [] (No local users).
forgejo_srv_local_users: []

# Enable polling for forgejo_cfg_server_http_port?
#
# Forgejo will report service is active and running but may not be ready to
# accept API requests for user modifications. Wait until the webserver is
# responding before attempting API calls. Automatically proceeds after
# forgejo_role_poll_timeout seconds.
#
# Disabling may lead to errors during role application:
#
#   Command error: database is locked
#
# Default: True (poll).
forgejo_srv_poll_enable: true

# Remove old installs on upgrade success? Default: True.
forgejo_srv_delete_old_versions_enable: true

# Force overwrite existing install?
#
# DATA DESTRUCTIVE.
#
# Removes existing cached downloaded archives and existing same-version install
# directories (if any). Any user data in these directories are DESTROYED.
#
# Default: False.
forgejo_srv_force_overwrite: false

# Automatically restart Forgejo daily? Default: False.
forgejo_srv_restart_daily_enable: false

# Only apply configuration?
#
# Reduces role application time by ONLY applying configuration changes. Does
# NOT affect forgejo_srv_media_set_perms_file_enable.
#
# This should ONLY be used after the role has been fully run once.
#
# Useful when adding a change without reconfiguring the whole system or
# checking and installing a new version. Suggest applying with extra options:
#
#   ansible-playbook site.yml
#       --tags Forgejo
#       -e 'forgejo_srv_force_config_only_enable=true'
#
# Default: False.
forgejo_srv_force_config_only_enable: false

# Is this role applied to a container?
#
# Decision: manual user setting - There is currently no good way to
#     deterministically and consistently detect if a remote host is a
#     container outside of common cases.
#
# Hosts marked as containers will automatically disable changes:
#   * ProtectHostname if forgejo_srv_harden_enable=true.
#
# Special Case:
#   * deb_container_enable=true forces forgejo_srv_container_enable=true.
#
# Default: False.
forgejo_srv_container_enable: false

###############################################################################
# Forgejo User
###############################################################################

# User that Forgejo will run under.
#
# Enable forgejo_srv_create_user if this account is not externally managed.
#
# Default: 'git'.
forgejo_srv_user: 'git'

# Group that Forgejo will run under.
#
# Enable forgejo_srv_create_user if this group is not externally managed.
#
# Default: 'git'.
forgejo_srv_group: 'git'

# Create forgejo_srv_user, forgejo_srv_group if not detected?
#
# Applied via r_pufky.deb.users, see vars/main.yml for default user attributes.
#
# Default: True.
forgejo_srv_create_user: true

# Enable user management of data/media files?
#
# Use forgejo_srv_user to execute data/media management commands. Role
# applies media permissions using 'root' by default. For mounted data locations
# (NFS with squashed mounts, mapped container mounts, etc) the local root user
# will not have sufficient privileges to modify these files.
#
# Applies to:
# * forgejo_cfg_repository_root
# * forgejo_cfg_storage_path (forgejo_cfg_storage_storage_type=local)
# * forgejo_cfg_storage_sub_system{}.PATH
#   (forgejo_cfg_storage_sub_system{}.STORAGE_TYPE=local)
# * forgejo_srv_backup_path (location)
# * ANY config paths which are nested under these directories.
#
# Default: False.
forgejo_srv_user_data_manage_enable: false

###############################################################################
# Forgejo Service Hardening
###############################################################################

# Harden Forgejo service?
#
# Applies systemd drop-in restricting Forgejo to:
# * NoNewPrivileges=true
# * PrivateTmp=true
# * ProtectHome=true
# * ProtectSystem=true
# * PrivateDevices=true
# * UMask='0077'
# * ProtectKernelTunables=true
# * ProtectKernelModules=true
# * ProtectKernelLogs=true
# * ProtectHostname=true (Disabled if running in a container).
# * ProtectClock=true
# * ProtectControlGroups=true
# * LockPersonality=true
# * RestrictRealtime=true
# * RestrictNamespacesAllow=true
# * RestrictSuidSgid=true
# * MemoryDenyWriteExecute=true
# * RemoveIpc=true
# * RestrictAddressFamilies=AF_INET,AF_INET6
# * RestrictAddressFamilies=~AF_UNIX
# * IpAccounting=true
# * AmbientCapabilities=CAP_NET_BIND_SERVICE
# * CapabilityBoundingSet=
#     ~CAP_AUDIT_CONTROL
#     ~CAP_AUDIT_READ
#     ~CAP_DAC_READ_SEARCH
#     ~CAP_SYS_RAWIO
#     ~CAP_SYS_PTRACE
#     ~CAP_DAC_* CAP_FOWNER CAP_IPC_OWNER
#     ~CAP_BPF
#     ~CAP_NET_ADMIN
#     ~CAP_KILL
#     ~CAP_NET_BROADCAST
#     ~CAP_SYS_NICE CAP_SYS_RESOURCE
#     ~CAP_SYS_BOOT
#     ~CAP_LINUX_IMMUTABLE
#     ~CAP_SYS_CHROOT
#     ~CAP_BLOCK_SUSPEND
#     ~CAP_LEASE
#     ~CAP_SYS_PACCT
#     ~CAP_SYS_TTY_CONFIG
#     ~CAP_SYS_ADMIN
#     ~CAP_SETUID CAP_SETGID
#     ~CAP_SETPCAP
#     ~CAP_CHOWN
#     ~CAP_FSETID CAP_SETFCAP
#     ~CAP_NET_RAW
#     ~CAP_IPC_LOCK
#
# Default: True.
forgejo_srv_harden_enable: true
